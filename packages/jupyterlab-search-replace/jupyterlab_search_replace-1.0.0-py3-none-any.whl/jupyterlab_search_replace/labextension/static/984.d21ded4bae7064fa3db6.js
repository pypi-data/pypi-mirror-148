"use strict";(self.webpackChunkjupyterlab_search_replace=self.webpackChunkjupyterlab_search_replace||[]).push([[984],{4770:(e,t,a)=>{a.r(t),a.d(t,{default:()=>M});var s=a(1175),r=a(8324),l=a(3660),n=a(3468),c=a(9093),i=a(5763),o=a(9321),h=a(5294),u=a(6271),p=a.n(u),m=a(3706);class d extends m.Widget{constructor(e,t){super({node:d.createNode(e,t)}),this._checkbox=this.node.querySelector('.jp-ask-checkbox > input[type="checkbox"]')}getValue(){return this._checkbox.checked}static createNode(e,t){const a=document.createElement("div");return a.insertAdjacentHTML("afterbegin",`<div><p>${e}</p></div>\n      <label class="jp-ask-checkbox"><input type="checkbox"></input>${t}</label>`),a}}var g=a(3986),_=a(5489),f=a(9131),E=a(3992),x=a(3812);const y=new c.LabIcon({name:"search-replace:wholeWord",svgstr:g.Z}),R=new c.LabIcon({name:"search-replace:expandAll",svgstr:_.Z}),S=new c.LabIcon({name:"search-replace:collapseAll",svgstr:f.Z}),w=new c.LabIcon({name:"search-replace:replaceAll",svgstr:E.Z}),F=new c.LabIcon({name:"search-replace:replace",svgstr:x.Z});function k(e){const{matches:t,path:a,expandStatus:s,maxMatchesPerFiles:r,setExpandStatus:l,onMatchClick:n,onReplace:c,trans:o}=e;if(0===t.length)return null;t.sort(((e,t)=>e.path>t.path?1:-1));const u=t.map(((e,t)=>{const u=e.matches.length>=r;return p().createElement(i.TreeItem,{className:"search-tree-files",expanded:s[t],onClick:()=>{const e=[...s];e[t]=!e[t],l(e)}},p().createElement("span",{title:e.path},e.path),c&&p().createElement(i.Button,{className:"jp-search-replace-item-button jp-mod-icon-only",appearance:"neutral",title:o.__("Replace All in File"),onClick:t=>{t.stopPropagation();const s=[{path:e.path,matches:e.matches}];c(s,h.PathExt.join(a,e.path))}},p().createElement(w.react,null)),u?p().createElement(i.Badge,{slot:"end",fill:"warning",color:"warning",title:o.__("Maximal number of matches is reached for this file. You can increase it in the settings.")},e.matches.length,u&&"+"):p().createElement(i.Badge,{slot:"end"},e.matches.length),e.matches.map((t=>{const s=c&&null!==t.replace;return p().createElement(i.TreeItem,{className:"search-tree-matches",onClick:s=>{s.stopPropagation(),n(h.PathExt.join(a,e.path),t)}},p().createElement("span",{title:t.line.trim()},t.line.slice(0,t.start_utf8),s?p().createElement(p().Fragment,null,p().createElement("del",null,t.match),p().createElement("ins",null,t.replace)):p().createElement("mark",null,t.match),t.line.slice(t.end_utf8)),s&&p().createElement(i.Button,{className:"jp-search-replace-item-button jp-mod-icon-only",appearance:"neutral",title:o.__("Replace"),onClick:s=>{s.stopPropagation();const r=[{path:e.path,matches:[t]}];c(r,h.PathExt.join(a,e.path))}},p().createElement(F.react,null)))})))}));return p().createElement("div",{className:"jp-search-replace-list"},p().createElement(i.TreeView,null,u))}class C extends o.VDomRenderer{constructor(e,t,a,s,r){super(e),this.commands=t,this.docManager=a,this.trans=s,this.onAskReplaceChanged=r,this._askReplaceConfirmation=!0,this.searchInputRef=p().createRef(),this.addClass("jp-search-replace-tab"),this.addClass("jp-search-replace-column")}get askReplaceConfirmation(){return this._askReplaceConfirmation}set askReplaceConfirmation(e){this._askReplaceConfirmation!==e&&(this._askReplaceConfirmation=e,this.onAskReplaceChanged(e))}onAfterShow(e){var t;super.onAfterShow(e),null===(t=this.searchInputRef.current)||void 0===t||t.focus()}render(){const e=this.model.queryResults.map((e=>e.path)),t=e.length,a=this.model.queryResults.reduce(((e,t)=>e+t.matches.length),0);let s=!1;if(this.docManager)for(const t of e){const e=this.docManager.findWidget(h.PathExt.join(this.model.path,t));if(e){const t=this.docManager.contextForWidget(e);if(null==t?void 0:t.model.dirty){s=!0;break}}}return p().createElement(v,{searchInputRef:this.searchInputRef,searchString:this.model.searchQuery,onSearchChanged:e=>{this.model.searchQuery=e},replaceString:this.model.replaceString,onReplaceString:e=>{this.model.replaceString=e},onReplace:async(e,s)=>{if(s)await this.replaceInFile(s,e[0].matches),this.model.refresh();else{if(this.askReplaceConfirmation){const e=await(0,o.showDialog)({title:this.trans.__("Replace All"),body:new d(this.trans._n("Replace %2 matche(s) accross %1 file with %3? This cannot be undone.","Replace %2 matches accross %1 files with %3? This cannot be undone.",t,a,this.model.replaceString),this.trans.__("Skip confirmation next time.")),buttons:[o.Dialog.cancelButton({label:this.trans.__("Cancel")}),o.Dialog.okButton({label:this.trans.__("Replace")})]});if(!e.button.accept)return;!0===e.value&&(this.askReplaceConfirmation=!1)}await this.model.replace(e)}},isLoading:this.model.isLoading,queryResults:this.model.queryResults,onMatchClick:(e,t)=>{this.openFile(e,t)},refresh:()=>{this.model.refresh()},path:this.model.path,onPathChanged:e=>{this.model.path=e},maxLinesPerFile:this.model.maxLinesPerFile,options:p().createElement(p().Fragment,null,p().createElement(i.Button,{className:"jp-mod-icon-only",title:this.trans.__("Match Case"),appearance:this.model.caseSensitive?"accent":"neutral",onClick:()=>{this.model.caseSensitive=!this.model.caseSensitive}},p().createElement(c.caseSensitiveIcon.react,null)),p().createElement(i.Button,{className:"jp-mod-icon-only",title:this.trans.__("Match Whole Word"),appearance:this.model.wholeWord?"accent":"neutral",onClick:()=>{this.model.wholeWord=!this.model.wholeWord}},p().createElement(y.react,null)),p().createElement(i.Button,{className:"jp-mod-icon-only",title:this.trans.__("Use Regular Expression"),appearance:this.model.useRegex?"accent":"neutral",onClick:()=>{this.model.useRegex=!this.model.useRegex}},p().createElement(c.regexIcon.react,null))),trans:this.trans},p().createElement(j,{includeFilters:this.model.includeFilters,excludeFilters:this.model.excludeFilters,onIncludeFiltersChange:e=>{this.model.includeFilters=e},onExcludeFiltersChange:e=>{this.model.excludeFilters=e},trans:this.trans}),s&&p().createElement("div",{className:"jp-search-replace-warning"},p().createElement("p",null,this.trans.__("You have unsaved changes. The result(s) may be inexact. Save your work and refresh."))),this.model.searchQuery&&p().createElement("p",{className:"jp-search-replace-statistics"},this.model.queryResults.length?this.trans._n("%2 result(s) in %1 file","%2 results in %1 files",t,a):this.trans.__("No results found.")))}async openFile(e,t){const a=await this.commands.execute("docmanager:open",{factory:"Editor",path:e});return t&&(await a.context.ready,a.content.editor.doc.setSelection({line:t.line_number-1,ch:t.start_utf8},{line:t.line_number-1,ch:t.end_utf8})),a}async replaceInFile(e,t){const a=await this.openFile(e);await a.context.ready;const s=a.content.editor;return t.sort(((e,t)=>e.line_number<t.line_number?1:e.line_number===t.line_number?e.start<t.start?1:e.start===t.start?0:-1:-1)).forEach((e=>{s.doc.setSelection({line:e.line_number-1,ch:e.start_utf8},{line:e.line_number-1,ch:e.end_utf8}),null!==e.replace&&s.doc.replaceSelection(e.replace)})),await this.commands.execute("docmanager:save"),a}}const b=p().memo((e=>{const t=e.path.split("/");return p().createElement(i.Breadcrumb,{className:"jp-search-replace-breadcrumb"},p().createElement(i.BreadcrumbItem,{key:"root",className:"jp-search-replace-breacrumbitem",title:"/"},p().createElement(i.Button,{className:"jp-mod-icon-only",appearance:"stealth",onClick:()=>{e.onPathChanged("")}},p().createElement(c.folderIcon.react,null))),e.path&&t.map(((a,s)=>{const r=t.slice(0,s+1).join("/");return p().createElement(i.BreadcrumbItem,{key:a,className:"jp-search-replace-breacrumbitem",style:{flexGrow:s+1,flexShrink:t.length-s-1},title:"/"+r},p().createElement(i.Button,{className:"jp-search-replace-pathbutton",appearance:"lightweight",onClick:()=>{e.onPathChanged(r)}},a))})))})),v=e=>{const[t,a]=(0,u.useState)(!1),[s,r]=(0,u.useState)(new Array(e.queryResults.length).fill(!0));(0,u.useEffect)((()=>{r(new Array(e.queryResults.length).fill(!0))}),[e.queryResults]);const l=s.some((e=>e)),n=t&&""!==e.replaceString&&e.queryResults.length>0;return p().createElement(p().Fragment,null,p().createElement("div",{className:"jp-stack-panel-header jp-search-replace-column"},p().createElement("div",{className:"jp-search-replace-header jp-search-replace-row"},p().createElement("h2",null,e.trans.__("Search")),p().createElement("div",{className:"jp-Toolbar-spacer"}),p().createElement(i.Toolbar,null,p().createElement(i.Button,{className:"jp-mod-icon-only",appearance:"stealth",title:e.trans.__("Refresh"),onClick:()=>{e.refresh()}},p().createElement(c.refreshIcon.react,null)),p().createElement(i.Button,{className:"jp-mod-icon-only",appearance:"stealth",title:l?e.trans.__("Collapse All"):e.trans.__("Expand All"),disabled:0===e.queryResults.length,onClick:()=>{const t=new Array(e.queryResults.length).fill(!l);r(t)}},l?p().createElement(S.react,null):p().createElement(R.react,null)))),p().createElement(b,{path:e.path,onPathChanged:e.onPathChanged})),p().createElement("div",{className:"jp-search-replace-row jp-search-replace-collapser"},p().createElement(i.Button,{className:"jp-mod-icon-only",appearance:"stealth",title:e.trans.__("Toggle Replace"),onClick:()=>{a(!t)}},t?p().createElement(c.caretDownIcon.react,null):p().createElement(c.caretRightIcon.react,null)),p().createElement("div",{className:"jp-search-replace-column"},p().createElement("div",{className:"jp-search-replace-row"},p().createElement(i.TextField,{ref:e.searchInputRef,appearance:"outline",type:"text",placeholder:e.trans.__("Search"),"aria-label":e.trans.__("Search Files for Text"),onChange:t=>{e.onSearchChanged(t.target.value)},onInput:t=>{e.onSearchChanged(t.target.value)},value:e.searchString}),p().createElement(i.Toolbar,null,e.options)),t&&p().createElement("div",{className:"jp-search-replace-row"},p().createElement(i.TextField,{appearance:"outline",placeholder:e.trans.__("Replace"),onInput:t=>{e.onReplaceString(t.target.value)},value:e.replaceString}),p().createElement(i.Button,{className:"jp-mod-icon-only",appearance:"stealth",title:e.trans.__("Replace All"),disabled:!n,onClick:()=>{e.onReplace(e.queryResults)}},p().createElement(w.react,null))))),e.children,e.isLoading?p().createElement(i.Progress,null):e.searchString&&p().createElement(k,{matches:e.queryResults,path:e.path,expandStatus:s,maxMatchesPerFiles:e.maxLinesPerFile,onMatchClick:e.onMatchClick,setExpandStatus:r,onReplace:n?e.onReplace:null,trans:e.trans}))},j=p().memo((e=>{const[t,a]=(0,u.useState)(!1),{includeFilters:s,onIncludeFiltersChange:r,excludeFilters:l,onExcludeFiltersChange:n,trans:o}=e;return p().createElement("div",{className:"jp-search-replace-filtersBox jp-search-replace-column"},p().createElement(i.Button,{className:"jp-search-replace-filters-collapser jp-mod-icon-only",appearance:"stealth",title:e.trans.__("Toggle Search Filters"),onClick:()=>{a(!t)}},p().createElement(c.ellipsesIcon.react,null)),t&&p().createElement(p().Fragment,null,p().createElement("label",{className:"jp-search-replace-column"},o.__("Include file filters"),p().createElement(i.TextField,{appearance:"outline",placeholder:o.__("e.g. *.py, src/**/include"),onChange:e=>{r(e.target.value)},onInput:e=>{r(e.target.value)},value:s})),p().createElement("label",{className:"jp-search-replace-column"},o.__("Exclude file filters"),p().createElement(i.TextField,{appearance:"outline",placeholder:o.__("e.g. *.py, src/**/exclude"),onChange:e=>{n(e.target.value)},onInput:e=>{n(e.target.value)},value:l}))))}));var N=a(1797),I=a(3114),L=a(8959);async function P(e="",t={}){const a=L.ServerConnection.makeSettings(),s=h.URLExt.join(a.baseUrl,"search",e);let r;try{r=await L.ServerConnection.makeRequest(s,t,a)}catch(e){throw new L.ServerConnection.NetworkError(e)}let l=await r.text();if(l.length>0)try{l=JSON.parse(l)}catch(e){console.log("Not a JSON response body.",r)}if(!r.ok)throw new L.ServerConnection.ResponseError(r,l.message||l);return l}const W=/\$[1-9]\d*/g;class q extends o.VDomModel{constructor(){super(),this._isLoading=!1,this._searchQuery="",this._queryResults=[],this._caseSensitive=!1,this._wholeWord=!1,this._useRegex=!1,this._excludeFilters="",this._includeFilters="",this._path="",this._replaceString="",this._replaceWorker=null,this._defaultExcludeFilters=[],this._maxLinesPerFile=100,this._debouncedSearch=new I.dx((async()=>{await this.search()}))}get caseSensitive(){return this._caseSensitive}set caseSensitive(e){e!==this._caseSensitive&&(this._caseSensitive=e,this.stateChanged.emit(),this.refresh())}get defaultExcludeFilters(){return this._defaultExcludeFilters}set defaultExcludeFilters(e){N.JSONExt.deepEqual(e,this._defaultExcludeFilters)||(this._defaultExcludeFilters=e,this.stateChanged.emit(),this.refresh())}get excludeFilters(){return this._excludeFilters}set excludeFilters(e){e!==this._excludeFilters&&(this._excludeFilters=e,this.stateChanged.emit(),this.refresh())}get includeFilters(){return this._includeFilters}set includeFilters(e){e!==this._includeFilters&&(this._includeFilters=e,this.stateChanged.emit(),this.refresh())}get isLoading(){return this._isLoading}set isLoading(e){e!==this._isLoading&&(this._isLoading=e,this.stateChanged.emit())}get path(){return this._path}set path(e){e!==this._path&&(this._path=e,this.stateChanged.emit(),this.refresh())}get queryResults(){return this._queryResults}get maxLinesPerFile(){return this._maxLinesPerFile}set maxLinesPerFile(e){e>=1&&e!==this._maxLinesPerFile&&(this._maxLinesPerFile=e,this.stateChanged.emit(),this.refresh())}get replaceString(){return this._replaceString}set replaceString(e){e!==this._replaceString&&(this._replaceString=e,this.stateChanged.emit(),this._updateReplace().then((()=>{this.stateChanged.emit()})).catch((e=>{console.error(`Failed to update replace expression.\n${e}`)})))}get searchQuery(){return this._searchQuery}set searchQuery(e){e!==this._searchQuery&&(this._searchQuery=e,this.stateChanged.emit(),this.refresh())}get useRegex(){return this._useRegex}set useRegex(e){e!==this._useRegex&&(this._useRegex=e,this.stateChanged.emit(),this.refresh())}get wholeWord(){return this._wholeWord}set wholeWord(e){e!==this._wholeWord&&(this._wholeWord=e,this.stateChanged.emit(),this.refresh())}refresh(){this._debouncedSearch.invoke().catch((e=>console.error(`Failed to invoke search.\n${e}`)))}async replace(e){try{await P(this.path,{method:"POST",body:JSON.stringify({matches:e})})}catch(e){console.error(`Failed to replace some matches.\n${e}`)}finally{this.refresh()}}async search(){const e=this.searchQuery,t=this.path;if(""===e)return this._queryResults=[],this.stateChanged.emit(),Promise.resolve();try{this.isLoading=!0;const a=[["query",e],["case_sensitive",this.caseSensitive.toString()],["whole_word",this.wholeWord.toString()],["use_regex",this.useRegex.toString()],["max_count",this.maxLinesPerFile.toString()]];a.push(...this.excludeFilters.split(",").concat(this.defaultExcludeFilters).map((e=>e.trim())).filter((e=>e)).map((e=>["exclude",e]))),a.push(...this.includeFilters.split(",").map((e=>e.trim())).filter((e=>e)).map((e=>["include",e])));const s=await P(t+"?"+new URLSearchParams(a).toString(),{method:"GET"});this._queryResults=s.matches,this.replaceString&&await this._updateReplace()}catch(a){console.error(`Failed to search for '${e}' in '${t}'.`,a),this._queryResults=[]}finally{this._isLoading=!1,this.stateChanged.emit()}}async _updateReplace(){const e=(e=null)=>{this._queryResults.forEach((t=>{t.matches.forEach((t=>{t.replace=e}))}))};if(null===this.replaceString.match(W))e(this.replaceString?this.replaceString:null);else{window.Worker||(console.error("Failed to build complex replacement expression because your browser does not support WebWorker."),e()),this._replaceWorker&&this._replaceWorker.terminate(),this._replaceWorker=new Worker(new URL(a.p+a.u(641),a.b));const t=new N.PromiseDelegate;this._replaceWorker.onerror=e=>{t.reject(e)},this._replaceWorker.onmessage=e=>{this._queryResults=e.data,t.resolve()},this._replaceWorker.postMessage([this.searchQuery,this.caseSensitive?"":"i",this.replaceString,this.queryResults]);try{await t.promise}catch(t){console.error(`Failed to build complex replacement expression.\n${t}`),e()}finally{this._replaceWorker.terminate(),this._replaceWorker=null}}}}var B=a(1226),T=a(6455);const A={id:"jupyterlab-search-replace:plugin",autoStart:!0,requires:[r.IFileBrowserFactory,l.IEditorTracker],optional:[T.IDocumentManager,B.ISettingRegistry,n.ITranslator],activate:(e,t,a,r,l,i)=>{const o=(null!=i?i:n.nullTranslator).load("search-replace");(0,s.e)();const h=new q;let u=null;const p=new C(h,e.commands,r,o,(async e=>{u&&await u.set("askReplaceAllConfirmation",e)}));l&&l.load(A.id).then((e=>{u=e;const t=e=>{h.defaultExcludeFilters=e.get("exclude").composite,h.maxLinesPerFile=e.get("maxLinesPerFile").composite,p.askReplaceConfirmation=e.get("askReplaceAllConfirmation").composite};t(e),e.changed.connect(t)})).catch((e=>{console.error(`Failed to load settings ${A.id}.`,e)}));const m=t.defaultBrowser;Promise.all([e.restored,m.model.restored]).then((()=>{h.path=m.model.path})),m.model.pathChanged.connect(((e,t)=>{h.path=t.newValue})),p.title.caption=o.__("Search and Replace"),p.id="jp-search-replace",p.title.icon=c.searchIcon,e.shell.add(p,"left")}},M=A}}]);